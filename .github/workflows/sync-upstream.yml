name: Sync Upstream and Create PR

on:
  schedule:
    # Run every Sunday at 00:00 UTC (æ¯å‘¨æ—¥ 00:00 UTC è¿è¡Œ)
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/iDvel/rime-ice.git || true
          git remote -v
      
      - name: Fetch upstream changes
        id: fetch
        run: |
          git fetch upstream main
          
          # Check if there are new commits in upstream
          LOCAL_COMMIT=$(git rev-parse origin/source 2>/dev/null || echo "")
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          
          echo "local_commit=$LOCAL_COMMIT" >> $GITHUB_OUTPUT
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          
          if [ "$LOCAL_COMMIT" = "$UPSTREAM_COMMIT" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No updates from upstream"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Updates available from upstream"
          fi
      
      - name: Sync to source branch
        if: steps.fetch.outputs.has_updates == 'true'
        run: |
          # Checkout or create source branch
          git checkout -B source upstream/main
          
          # Push to origin/source
          git push origin source --force
      
      - name: Check if PR already exists
        if: steps.fetch.outputs.has_updates == 'true'
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check for existing open PRs from source to main
          PR_COUNT=$(gh pr list --head source --base main --state open --json number --jq 'length')
          
          if [ "$PR_COUNT" -gt 0 ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            PR_NUMBER=$(gh pr list --head source --base main --state open --json number --jq '.[0].number')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "PR already exists: #$PR_NUMBER"
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi
      
      - name: Create Pull Request
        if: steps.fetch.outputs.has_updates == 'true' && steps.check_pr.outputs.pr_exists == 'false'
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the latest commit message from upstream
          LATEST_COMMIT=$(git log upstream/main -1 --pretty=format:"%s")
          
          # Create PR with multiline body
          PR_BODY=$(cat <<EOF
          ## ä¸Šæ¸¸åŒæ­¥æ›´æ–°
          
          æ­¤ PR è‡ªåŠ¨ä»Žä¸Šæ¸¸ä»“åº“ [iDvel/rime-ice](https://github.com/iDvel/rime-ice) åŒæ­¥æœ€æ–°æ›´æ”¹åˆ° \`source\` åˆ†æ”¯ã€‚
          
          **ä¸Šæ¸¸æœ€æ–°æäº¤:** $LATEST_COMMIT
          
          **ä¸Šæ¸¸æäº¤ SHA:** ${{ steps.fetch.outputs.upstream_commit }}
          
          **æœ¬åœ°æäº¤ SHA (æ›´æ–°å‰):** ${{ steps.fetch.outputs.local_commit }}
          
          ### âš ï¸ è¯·æ³¨æ„
          - è¯·ä»”ç»†æ£€æŸ¥æ›´æ”¹å†…å®¹
          - ç¡®è®¤æ²¡æœ‰å†²çªåŽå†æ‰‹åŠ¨åˆå¹¶
          - å»ºè®®åœ¨æœ¬åœ°æµ‹è¯•åŽå†åˆå¹¶åˆ° main åˆ†æ”¯
          
          ---
          ðŸ¤– æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º
          EOF
          )
          
          # Create PR
          PR_URL=$(gh pr create \
            --base main \
            --head source \
            --title "Sync upstream changes from iDvel/rime-ice" \
            --body "$PR_BODY")
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "Created PR: $PR_URL"
      
      - name: Send email notification
        if: steps.fetch.outputs.has_updates == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[rime-ice] Upstream sync - New PR created"
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: |
            Hello,
            
            The upstream repository iDvel/rime-ice has new updates.
            
            A pull request has been created to merge these changes from the 'source' branch to 'main'.
            
            PR Details:
            - PR URL: ${{ steps.create_pr.outputs.pr_url || 'PR already exists' }}
            - Upstream commit: ${{ steps.fetch.outputs.upstream_commit }}
            - Previous local commit: ${{ steps.fetch.outputs.local_commit }}
            
            Please review and manually merge the PR when ready.
            
            ---
            This is an automated notification from GitHub Actions.
      
      - name: No updates notification
        if: steps.fetch.outputs.has_updates == 'false'
        run: |
          echo "âœ… No updates from upstream. Repository is up to date."
